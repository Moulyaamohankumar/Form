name: Scheduled Form Submit

on:
  schedule:
    # Runs at 19:00 IST (UTC+5:30) Monday - Saturday -> 13:30 UTC
    - cron: '30 13 * * 1-6'
  workflow_dispatch: {}

jobs:
  run-form:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps for Puppeteer (safety)
        run: |
          sudo apt-get update
          # On Ubuntu 24.04 (noble) some packages are provided under different names;
          # use libasound2t64 which provides the ALSA libs instead of libasound2.
          sudo apt-get install -y ca-certificates fonts-liberation libatk-bridge2.0-0 libatk1.0-0 libcups2 libdbus-1-3 libgdk-pixbuf2.0-0 libnspr4 libnss3 libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 xvfb libasound2t64 libxss1

      - name: Install Node dependencies
        run: |
          cd WorkLog_Submission-main
          # use npm install which is tolerant if package-lock.json is missing
          npm install

      - name: Run form script with screenshot injection
        env:
          HEADLESS: 'true'
        run: |
          cd WorkLog_Submission-main
          # Create a temporary modified version that adds screenshot before end of try block
          cp index.js index-original.js
          sed -i "s/console.log(new Date().toISOString(), 'Form fill finished');/await page.screenshot({ path: 'form-final-state.png', fullPage: true }); console.log(new Date().toISOString(), 'Screenshot captured'); console.log(new Date().toISOString(), 'Form fill finished');/g" index.js
          node index.js
          # Restore original
          mv index-original.js index.js

      - name: Upload screenshot artifacts (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: form-screenshots-${{ github.run_number }}
          path: WorkLog_Submission-main/*.png
          if-no-files-found: ignore
